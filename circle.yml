machine:
  timezone: Asia/Tokyo
  environment:
    USERNAME: 'youyo'
    CIRCLE_PROJECT_REPONAME: 'recorder'
    GO15VENDOREXPERIMENT: 1
    GOVERSION: 1.6.1
    GODIST: "go$GOVERSION.linux-amd64.tar.gz"
  post:
    - sudo mkdir -p ~/download
    - sudo test -e ~/download/$GODIST || sudo curl -o ~/download/$GODIST https://storage.googleapis.com/golang/$GODIST
    - sudo rm -rf /usr/local/go
    - sudo tar -C /usr/local -xzf ~/download/$GODIST
    - rm -rf $GOPATH/src/*
    - mkdir -p $HOME/.go_workspace/src/github.com/$CIRCLE_PROJECT_USERNAME/
    - cd $HOME/.go_workspace/src/github.com/$CIRCLE_PROJECT_USERNAME
    - mv $HOME/$CIRCLE_PROJECT_REPONAME .
    - cd $CIRCLE_PROJECT_REPONAME/

dependencies:
  cache_directories:
    - ~/download
  pre:
    - |
      go get -v github.com/mitchellh/gox
      go get -v github.com/tcnksm/ghr
      go get -v github.com/Masterminds/glide
  override:
    - |
      cd $HOME/.go_workspace/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/
      glide up

test:
  override:
    - |
      cd $HOME/.go_workspace/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/
      go test $(glide novendor)

deployment:
  release:
    branch: master
    commands:
      - |
        cd $HOME/.go_workspace/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/
        gox --osarch "linux/amd64" --output "dist/{{.Dir}}_{{.OS}}_{{.Arch}}"
        ghr -t ${GITHUB_TOKEN} -u $USERNAME -r $CIRCLE_PROJECT_REPONAME --replace `cat version.go | grep -w 'const Version string' | awk -F '"' '{print "v"$2}'` dist/
